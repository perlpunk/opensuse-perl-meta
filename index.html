<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>devel:languages:perl metadata</title>
    <style>
        :root {
            font-family: 'Inter', sans-serif;
        }
        /* Global & Container Styles */
        body {
            background-color: #f9fafb; /* Light background */
            min-height: 100vh;
            padding: 10px;
        }
        .container {
            margin: 0 auto;
            background-color: #fff;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            border-radius: 8px;
            padding: 20px;
        }
        h1 {
            font-size: 24px;
            font-weight: bold;
            color: #333;
            margin-bottom: 10px;
            border-bottom: 1px solid #ccc;
            padding-bottom: 10px;
        }

        /* Loading Spinner */
        .spinner {
            border: 3px solid rgba(0, 0, 0, 0.1);
            border-top-color: #3498db;
            border-radius: 50%;
            width: 16px;
            height: 16px;
            animation: spin 1s linear infinite;
            display: inline-block;
            margin-right: 8px;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Message Styles */
        .status-item {
            display: flex;
            align-items: center;
            font-weight: 500;
            margin-bottom: 15px;
        }
        .status-loading { color: #3498db; }
        .status-success { color: #27ae60; }
        .status-error {
            color: #c0392b;
            background-color: #fcebeb;
            padding: 10px;
            border-radius: 4px;
        }

        /* Table Styles */
        table.main {
            width: 100%;
            border-collapse: collapse;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            border-radius: 6px;
            overflow: hidden;
        }
        table.main thead {
            background-color: #ecf0f1;
        }
        table.main th, table.main td {
            padding: 8px 10px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        table.main th {
            font-size: 12px;
            color: #7f8c8d;
            text-transform: uppercase;
        }
        /* Simple zebra striping and hover */
        table.main tbody tr:nth-child(even) {
            background-color: #f4f6f7;
        }
        table.main tbody tr:hover {
            background-color: #e8f0f3;
            transition: background-color 0.2s;
        }
        table.cpanspec {
            border-collapse: collapse;
        }
        table.cpanspec td {
            padding: 0.5em;
            text-align: left;
            vertical-align: top;
            border: 1px solid #ddd;
        }

        /* Boolean Spans (Yes/No) */
        .status-yes, .status-no {
            padding: 4px 8px;
            font-size: 11px;
            font-weight: bold;
            border-radius: 12px;
            display: inline-block;
            line-height: 1;
        }
        .status-yes {
            background-color: #d4edda;
            color: #155724;
        }
        .status-no {
            background-color: #f8d7da;
            color: #721c24;
        }
        table.main a {
            color: #2266cc;
            text-decoration: none;
        }
        table.main a:visited {
            color: #8866cc;
            text-decoration: none;
        }

        .info-card {
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
            width: 100%;
            max-width: 1000px;
            text-align: left;
            transform: scale(0.9);
            opacity: 0;
            transition: transform 0.3s ease-out, opacity 0.3s ease-out;
            overflow: auto;
        }
        .modal-overlay {
            /* Full screen overlay to dim the background */
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: none; /* Initially hidden */
            justify-content: center;
            align-items: center;
            z-index: 1000; /* Ensure it is on top of everything */
        }
        .modal-overlay.visible {
            display: flex;
        }

        .modal-overlay.visible .info-card {
            transform: scale(1);
            opacity: 1;
        }
        .close-btn {
            float: right;
            font-size: 24px;
            font-weight: bold;
            line-height: 1;
            color: #94a3b8;
            cursor: pointer;
            transition: color 0.2s;
        }

        .close-btn:hover {
            color: #ef4444;
        }

        button.infoLink {
            background-color: #88bbff;
            padding: 2px 10px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            transition: background-color 0.3s, transform 0.1s;
        }

        button.infoLink:hover {
            background-color: #1d4ed8;
            color: white;
        }

        #navi {
          float: right;
          top: 0px;
        }
    </style>
</head>
<body>

    <div id="navi">
      <a href="https://github.com/perlpunk/opensuse-devel-languages-perl-meta"><img src="img/github-mark.png" width="30"></a>
    </div>
    <div class="container">

        <h1>devel:languages:perl metadata</h1>
        <p>
            For openSUSE we maintain the
            <a href="https://build.opensuse.org/project/show/devel:languages:perl">devel:languages:perl</a>
            repository with around 3k perl modules.
            About half of them are in the official distributions like Tumbleweed
            and Leap.
            <br>
            The sources are maintained in <a href="https://src.opensuse.org/perl">git</a>.
            <br>
            Here you can find all devel modules with their versions and additional
            information, for example if we have local modifications (additional
            dependencies, patches).
        </p>

        <div id="message-container">
            <p id="status-message" style="color: #6c757d; font-style: italic;">Fetching data...</p>
        </div>

        <div id="table-container">
        </div>
        <hr>
        Data retrieved from
        <a href="https://src.opensuse.org/perl/_ObsPrj">perl/_ObsPrj</a><br>
        at commit
        <a id="commit-link" href="https://src.opensuse.org/perl/_ObsPrj/commit/"><span id="commit-sha">...</span></a>
        at <span id="last-updated">...</span><br>
        Download <a href="./meta.yaml">meta.yaml</a> / <a href="./meta.json">meta.json</a><br>

    </div>

    <div id="popupOverlay" class="modal-overlay">
        <div class="info-card">
            <span class="close-btn" id="closePopup">&times;</span>
            <h3 id="info-card-title">cpanspec.yml</h3>
            <pre id="cpanspec-content"></pre>
        </div>
    </div>

    <script>
        const tableContainer = document.getElementById('table-container');
        const messageContainer = document.getElementById('message-container');
        const lastUpdatedSpan = document.getElementById('last-updated');
        const commitShaSpan = document.getElementById('commit-sha');
        const commitLink = document.getElementById('commit-link');
        let metadata;

        const dataUrl = 'meta.json';

        function showMessage(type, message) {
            messageContainer.innerHTML = '';
            let icon = '';
            let statusClass = 'status-item';

            if (type === 'loading') {
                icon = `<div class="spinner"></div>`;
                statusClass += ' status-loading';
            } else if (type === 'success') {
                icon = '';
                statusClass += ' status-success';
            } else if (type === 'error') {
                icon = '‚ùå ';
                statusClass += ' status-error';
            }

            messageContainer.innerHTML = `
                <div class="${statusClass}">
                    ${icon}
                    <span>${message}</span>
                </div>
            `;
        }

        function buildTable(data) {
            if (!data || Object.keys(data) === 0) {
                tableContainer.innerHTML = '<p style="color: #6b7280;">No data records found to display.</p>';
                return;
            }
            lastUpdatedSpan.innerHTML = data["last_commit"]["date"];
            commitShaSpan.innerHTML = data["last_commit"]["sha"];
            commitLink.href += data["last_commit"]["sha"];

            const headers = [
                ["Module", "Module name"],
                ["Version", "Module version"],
                ["Dependencies", "BuildRequires / Requires / Recommends"],
                ["Overrides", "cpanspec.yml has entries that modify the spec"],
                ["Patches", "There are patches"],
                ["Updated", "Date of last git commit"],
            ];

            let tableHTML = `
                <table class="main">
                    <thead>
                        <tr>
                            ${headers.map(header =>
                                `<th scope="col" title="${header[1]}">${header[0]}</th>`
                            ).join('')}
                        </tr>
                    </thead>
                    <tbody>
            `;

            Object.entries(data["packages"]).sort().forEach(([pkg, value]) => {

                let buildReq = 0;
                let req = 0;
                let rec = 0;
                let deps = '';
                if ('build_requires' in value) {
                    buildReq = value["build_requires"].length;
                }
                deps += buildReq;
                if ('requires' in value) {
                    req = value["requires"].length;
                }
                deps += ' / ' + req;
                if ('recommends' in value) {
                    console.log(pkg);
                    rec = value["recommends"].length;
                }
                deps += ' / ' + rec;

                tableHTML += `<tr>`;
                entry = {
                  Module: pkg,
                  Version: value["version"],
                  Overrides: "cpanspec" in value ? "yes" : "-",
                  Patches: value["cpanspec"] && value["cpanspec"]["patches"] ? Object.keys(value["cpanspec"]["patches"]).length : "-",
                  Updated: value["last_commit"]["date"],
                  Dependencies: (buildReq + req) > 0 ? deps : '-',
                }

                headers.forEach(key => {
                    let cellContent = entry[key[0]];
                    let cellClasses = "";
                    if (key[0] === 'Module') {
                        cellContent = `<a href="https://src.opensuse.org/perl/${cellContent}">${cellContent}</a>`;
                    }
                    else if (key[0] === 'Overrides' && cellContent === 'yes') {
                        cellContent = `<button class="infoLink" onClick="showCpanspec('${pkg}')">${cellContent}</button>`;
                    }
                    else if (key[0] === 'Patches' && cellContent !== '-') {
                        cellContent = `<button class="infoLink" onClick="showPatches('${pkg}')">${cellContent}</button>`;
                    }
                    else if (key[0] === 'Dependencies' && cellContent !== '-') {
                        cellContent = `<button class="infoLink" onClick="showDeps('${pkg}')">${cellContent}</button>`;
                    }
                    tableHTML += `<td class="${cellClasses}">${cellContent}</td>`;
                });

                tableHTML += `</tr>`;
            });

            tableHTML += `
                    </tbody>
                </table>
            `;

            tableContainer.innerHTML = tableHTML;
        }

        const popupOverlay = document.getElementById('popupOverlay');
        const cpanspecContent = document.getElementById('cpanspec-content');
        const infoTitle = document.getElementById('info-card-title');
        const closePopupBtn = document.getElementById('closePopup');
        closePopupBtn.addEventListener('click', hidePopup);

        popupOverlay.addEventListener('click', function(event) {
            if (event.target === popupOverlay) {
                hidePopup();
            }
        });

        function showCpanspec(pkg) {
            pkgdata = metadata["packages"][pkg]["cpanspec"];

            let table = '<table class="cpanspec">';
            Object.entries(pkgdata).sort().forEach(([key, value]) => {
                if (typeof value === 'object' || typeof value === 'array') {
                    value = JSON.stringify(value, null, 2);
                }
                let line = '<tr><td>'
                    + sanitizeHTML(key) + ":</td><td>" + sanitizeHTML(value)
                    + "</td></tr>";
                table += line;
            });
            table += '</table>';
            let title = "cpanspec YAML for " + pkg;
            showInfoCard(title, table);
        }

        function showPatches(pkg) {
            patches = metadata["packages"][pkg]["cpanspec"]["patches"];
            let table = '<table class="cpanspec">';
            Object.entries(patches).sort().forEach(([key, value]) => {
                if (value === null) {
                    value = '';
                }
                key = sanitizeHTML(key);
                let line = '<tr><td>'
                    + '<a href="https://src.opensuse.org/perl/' + pkg + '/src/branch/main/'+key+'">' + key + '</a>'
                    + ":</td><td>" + sanitizeHTML(value)
                    + "</td></tr>";
                table += line;
            });
            table += '</table>';
            showInfoCard("Patches for " + pkg, table);
        }

        function showDeps(pkg) {
            pkgdata = metadata["packages"][pkg];
            let table = '<table class="cpanspec">';
            if ('build_requires' in pkgdata) {
                let line = '<tr><td>BuildRequires</td><td>';
                pkgdata["build_requires"].forEach((dep) => {
                    line += dep + '<br>';
                });
                line += '</td></tr>';
                table += line;
            }
            if ('requires' in pkgdata) {
                let line = '<tr><td>Requires</td><td>';
                pkgdata["requires"].forEach((dep) => {
                    line += dep + '<br>';
                });
                line += '</td></tr>';
                table += line;
            }
            if ('recommends' in pkgdata) {
                let line = '<tr><td>Recommends</td><td>';
                pkgdata["recommends"].forEach((dep) => {
                    line += dep + '<br>';
                });
                line += '</td></tr>';
                table += line;
            }
            table += '</table>';
            showInfoCard("Dependencies for " + pkg, table);
        }

        function showInfoCard(title, content) {
            cpanspecContent.innerHTML = content;
            infoTitle.innerHTML = title;
            popupOverlay.classList.add('visible');
        }

        document.addEventListener('keyup', function(event) {
            if (event.key === 'Escape') {
                hidePopup();
            }
        });
        var sanitizeHTML = function (str) {
            return str.toString().replace(/[^\w. ]/gi, function (c) {
                return '&#' + c.charCodeAt(0) + ';';
            });
        };
        function hidePopup() {
            popupOverlay.classList.remove('visible');
        }

        async function fetchWithRetry(url, maxRetries = 1) {
            for (let i = 0; i < maxRetries; i++) {
                try {
                    const response = await fetch(url);
                    return response;
                } catch (error) {
                    console.error(`Attempt ${i + 1} failed:`, error.message);
                    if (i === maxRetries - 1) {
                        throw new Error('All fetch attempts failed.');
                    }
                    const delay = Math.pow(2, i) * 1000; // 1s, 2s, 4s delay
                    await new Promise(resolve => setTimeout(resolve, delay));
                }
            }
        }

        async function fetchDataAndBuildTable() {
            tableContainer.innerHTML = '';
            showMessage('loading', `Loading data from ${dataUrl}...`);

            try {
                const response = await fetchWithRetry(dataUrl);

                if (!response.ok) {
                    throw new Error(`Server responded with status: ${response.status}`);
                }

                const json = await response.json();
                metadata = json;
                buildTable(json);
                showMessage('success', ``);
            } catch (error) {
                console.error("Critical Fetch Error:", error);
                showMessage('error', `Failed to load data. ${error.message}`);
                tableContainer.innerHTML = '';
            }
        }

        document.addEventListener('DOMContentLoaded', fetchDataAndBuildTable);
    </script>
</body>
</html>
